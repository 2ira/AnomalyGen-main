{
    "org.apache.zookeeper.server.ZooKeeperServer:processPacket(org.apache.zookeeper.server.ServerCnxn,java.nio.ByteBuffer)": {
        "source_code": "public void processPacket(ServerCnxn cnxn, RequestHeader h, RequestRecord request) throws IOException {\n    // Need to increase the outstanding request count first, otherwise\n    // there might be a race condition that it enabled recv after\n    // processing request and then disabled when check throttling.\n    //\n    // Be aware that we're actually checking the global outstanding\n    // request before this request.\n    //\n    // It's fine if the IOException thrown before we decrease the count\n    // in cnxn, since it will close the cnxn anyway.\n    cnxn.incrOutstandingAndCheckThrottle(h);\n    if (h.getType() == OpCode.auth) {\n        LOG.info(\"got auth packet {}\", cnxn.getRemoteSocketAddress());\n        AuthPacket authPacket = request.readRecord(AuthPacket::new);\n        String scheme = authPacket.getScheme();\n        ServerAuthenticationProvider ap = ProviderRegistry.getServerProvider(scheme);\n        Code authReturn = KeeperException.Code.AUTHFAILED;\n        if (ap != null) {\n            try {\n                // handleAuthentication may close the connection, to allow the client to choose\n                // a different server to connect to.\n                authReturn = ap.handleAuthentication(new ServerAuthenticationProvider.ServerObjs(this, cnxn), authPacket.getAuth());\n            } catch (RuntimeException e) {\n                LOG.warn(\"Caught runtime exception from AuthenticationProvider: {}\", scheme, e);\n                authReturn = KeeperException.Code.AUTHFAILED;\n            }\n        }\n        if (authReturn == KeeperException.Code.OK) {\n            LOG.info(\"Session 0x{}: auth success for scheme {} and address {}\", Long.toHexString(cnxn.getSessionId()), scheme, cnxn.getRemoteSocketAddress());\n            ReplyHeader rh = new ReplyHeader(h.getXid(), 0, KeeperException.Code.OK.intValue());\n            cnxn.sendResponse(rh, null, null);\n        } else {\n            if (ap == null) {\n                LOG.warn(\"No authentication provider for scheme: {} has {}\", scheme, ProviderRegistry.listProviders());\n            } else {\n                LOG.warn(\"Authentication failed for scheme: {}\", scheme);\n            }\n            // send a response...\n            ReplyHeader rh = new ReplyHeader(h.getXid(), 0, KeeperException.Code.AUTHFAILED.intValue());\n            cnxn.sendResponse(rh, null, null);\n            // ... and close connection\n            cnxn.sendBuffer(ServerCnxnFactory.closeConn);\n            cnxn.disableRecv();\n        }\n        return;\n    } else if (h.getType() == OpCode.sasl) {\n        processSasl(request, cnxn, h);\n    } else {\n        if (!authHelper.enforceAuthentication(cnxn, h.getXid())) {\n            // Authentication enforcement is failed\n            // Already sent response to user about failure and closed the session, lets return\n            return;\n        } else {\n            Request si = new Request(cnxn, cnxn.getSessionId(), h.getXid(), h.getType(), request, cnxn.getAuthInfo());\n            int length = request.limit();\n            if (isLargeRequest(length)) {\n                // checkRequestSize will throw IOException if request is rejected\n                checkRequestSizeWhenMessageReceived(length);\n                si.setLargeRequestSize(length);\n            }\n            si.setOwner(ServerCnxn.me);\n            submitRequest(si);\n        }\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:readConnectRequest()": {
        "source_code": "private void readConnectRequest() throws IOException, ClientCnxnLimitException {\n    if (!isZKServerRunning()) {\n        throw new IOException(\"ZooKeeperServer not running\");\n    }\n    BinaryInputArchive bia = BinaryInputArchive.getArchive(new ByteBufferInputStream(incomingBuffer));\n    ConnectRequest request = protocolManager.deserializeConnectRequest(bia);\n    zkServer.processConnectRequest(this, request);\n    initialized = true;\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:readPayload()": {
        "source_code": "/**\n * Read the request payload (everything following the length prefix)\n */\nprivate void readPayload() throws IOException, InterruptedException, ClientCnxnLimitException {\n    if (incomingBuffer.remaining() != 0) {\n        // have we read length bytes?\n        // sock is non-blocking, so ok\n        int rc = sock.read(incomingBuffer);\n        if (rc < 0) {\n            handleFailedRead();\n        }\n    }\n    if (incomingBuffer.remaining() == 0) {\n        // have we read length bytes?\n        incomingBuffer.flip();\n        packetReceived(4 + incomingBuffer.remaining());\n        if (!initialized) {\n            readConnectRequest();\n        } else {\n            readRequest();\n        }\n        lenBuffer.clear();\n        incomingBuffer = lenBuffer;\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:readRequest()": {
        "source_code": "protected void readRequest() throws IOException {\n    RequestHeader h = new RequestHeader();\n    ByteBufferInputStream.byteBuffer2Record(incomingBuffer, h);\n    RequestRecord request = RequestRecord.fromBytes(incomingBuffer.slice());\n    zkServer.processPacket(this, h, request);\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.ZooKeeperServer:processConnectRequest(org.apache.zookeeper.server.ServerCnxn,java.nio.ByteBuffer)": {
        "source_code": "@SuppressFBWarnings(value = \"IS2_INCONSISTENT_SYNC\", justification = \"the value won't change after startup\")\npublic void processConnectRequest(ServerCnxn cnxn, ConnectRequest request) throws IOException, ClientCnxnLimitException {\n    LOG.debug(\"Session establishment request from client {} client's lastZxid is 0x{}\", cnxn.getRemoteSocketAddress(), Long.toHexString(request.getLastZxidSeen()));\n    long sessionId = request.getSessionId();\n    int tokensNeeded = 1;\n    if (connThrottle.isConnectionWeightEnabled()) {\n        if (sessionId == 0) {\n            if (localSessionEnabled) {\n                tokensNeeded = connThrottle.getRequiredTokensForLocal();\n            } else {\n                tokensNeeded = connThrottle.getRequiredTokensForGlobal();\n            }\n        } else {\n            tokensNeeded = connThrottle.getRequiredTokensForRenew();\n        }\n    }\n    if (!connThrottle.checkLimit(tokensNeeded)) {\n        throw new ClientCnxnLimitException();\n    }\n    ServerMetrics.getMetrics().CONNECTION_TOKEN_DEFICIT.add(connThrottle.getDeficit());\n    ServerMetrics.getMetrics().CONNECTION_REQUEST_COUNT.add(1);\n    if (!cnxn.protocolManager.isReadonlyAvailable()) {\n        LOG.warn(\"Connection request from old client {}; will be dropped if server is in r-o mode\", cnxn.getRemoteSocketAddress());\n    }\n    if (!request.getReadOnly() && this instanceof ReadOnlyZooKeeperServer) {\n        String msg = \"Refusing session request for not-read-only client \" + cnxn.getRemoteSocketAddress();\n        LOG.info(msg);\n        throw new CloseRequestException(msg, ServerCnxn.DisconnectReason.NOT_READ_ONLY_CLIENT);\n    }\n    if (request.getLastZxidSeen() > zkDb.dataTree.lastProcessedZxid) {\n        String msg = \"Refusing session(0x\" + Long.toHexString(sessionId) + \") request for client \" + cnxn.getRemoteSocketAddress() + \" as it has seen zxid 0x\" + Long.toHexString(request.getLastZxidSeen()) + \" our last zxid is 0x\" + Long.toHexString(getZKDatabase().getDataTreeLastProcessedZxid()) + \" client must try another server\";\n        LOG.info(msg);\n        throw new CloseRequestException(msg, ServerCnxn.DisconnectReason.CLIENT_ZXID_AHEAD);\n    }\n    int sessionTimeout = request.getTimeOut();\n    byte[] passwd = request.getPasswd();\n    int minSessionTimeout = getMinSessionTimeout();\n    if (sessionTimeout < minSessionTimeout) {\n        sessionTimeout = minSessionTimeout;\n    }\n    int maxSessionTimeout = getMaxSessionTimeout();\n    if (sessionTimeout > maxSessionTimeout) {\n        sessionTimeout = maxSessionTimeout;\n    }\n    cnxn.setSessionTimeout(sessionTimeout);\n    // We don't want to receive any packets until we are sure that the\n    // session is setup\n    cnxn.disableRecv();\n    if (sessionId == 0) {\n        long id = createSession(cnxn, passwd, sessionTimeout);\n        LOG.debug(\"Client attempting to establish new session: session = 0x{}, zxid = 0x{}, timeout = {}, address = {}\", Long.toHexString(id), Long.toHexString(request.getLastZxidSeen()), request.getTimeOut(), cnxn.getRemoteSocketAddress());\n    } else {\n        validateSession(cnxn, sessionId);\n        LOG.debug(\"Client attempting to renew session: session = 0x{}, zxid = 0x{}, timeout = {}, address = {}\", Long.toHexString(sessionId), Long.toHexString(request.getLastZxidSeen()), request.getTimeOut(), cnxn.getRemoteSocketAddress());\n        if (serverCnxnFactory != null) {\n            serverCnxnFactory.closeSession(sessionId, ServerCnxn.DisconnectReason.CLIENT_RECONNECT);\n        }\n        if (secureServerCnxnFactory != null) {\n            secureServerCnxnFactory.closeSession(sessionId, ServerCnxn.DisconnectReason.CLIENT_RECONNECT);\n        }\n        cnxn.setSessionId(sessionId);\n        reopenSession(cnxn, sessionId, passwd, sessionTimeout);\n        ServerMetrics.getMetrics().CONNECTION_REVALIDATE_COUNT.add(1);\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java"
    },
    "org.apache.zookeeper.server.ServerCnxn:getAuthInfo()": {
        "source_code": "/**\n * auth info for the cnxn, returns an unmodifyable list\n */\npublic List<Id> getAuthInfo() {\n    return Collections.unmodifiableList(new ArrayList<>(authInfo));\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ServerCnxn.java"
    }
}