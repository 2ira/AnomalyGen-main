{
    "org.apache.zookeeper.server.NIOServerCnxn:doIO(java.nio.channels.SelectionKey)": {
        "source_code": "/**\n * Handles read/write IO on connection.\n */\nvoid doIO(SelectionKey k) throws InterruptedException {\n    try {\n        if (!isSocketOpen()) {\n            LOG.warn(\"trying to do i/o on a null socket for session: 0x{}\", Long.toHexString(sessionId));\n            return;\n        }\n        if (k.isReadable()) {\n            int rc = sock.read(incomingBuffer);\n            if (rc < 0) {\n                try {\n                    handleFailedRead();\n                } catch (EndOfStreamException e) {\n                    // no stacktrace. this case is very common, and it is usually not a problem.\n                    LOG.info(\"{}\", e.getMessage());\n                    // expecting close to log session closure\n                    close(e.getReason());\n                    return;\n                }\n            }\n            if (incomingBuffer.remaining() == 0) {\n                boolean isPayload;\n                if (incomingBuffer == lenBuffer) {\n                    // start of next request\n                    incomingBuffer.flip();\n                    isPayload = readLength(k);\n                    incomingBuffer.clear();\n                } else {\n                    // continuation\n                    isPayload = true;\n                }\n                if (isPayload) {\n                    // not the case for 4letterword\n                    readPayload();\n                } else {\n                    // four letter words take care\n                    // need not do anything else\n                    return;\n                }\n            }\n        }\n        if (k.isWritable()) {\n            handleWrite(k);\n            if (!initialized && !getReadInterest() && !getWriteInterest()) {\n                throw new CloseRequestException(\"responded to info probe\", DisconnectReason.INFO_PROBE);\n            }\n        }\n    } catch (CancelledKeyException e) {\n        LOG.warn(\"CancelledKeyException causing close of session: 0x{}\", Long.toHexString(sessionId));\n        LOG.debug(\"CancelledKeyException stack trace\", e);\n        close(DisconnectReason.CANCELLED_KEY_EXCEPTION);\n    } catch (CloseRequestException e) {\n        // expecting close to log session closure\n        close();\n    } catch (EndOfStreamException e) {\n        LOG.warn(\"Unexpected exception\", e);\n        // expecting close to log session closure\n        close(e.getReason());\n    } catch (ClientCnxnLimitException e) {\n        // Common case exception, print at debug level\n        ServerMetrics.getMetrics().CONNECTION_REJECTED.add(1);\n        LOG.warn(\"Closing session 0x{}\", Long.toHexString(sessionId), e);\n        close(DisconnectReason.CLIENT_CNX_LIMIT);\n    } catch (IOException e) {\n        LOG.warn(\"Close of session 0x{}\", Long.toHexString(sessionId), e);\n        close(DisconnectReason.IO_EXCEPTION);\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.ZooTrace:setTextTraceLevel(long)": {
        "source_code": "public static synchronized void setTextTraceLevel(long mask) {\n    traceMask = mask;\n    final Logger LOG = LoggerFactory.getLogger(ZooTrace.class);\n    LOG.info(\"Set text trace mask to 0x{}\", Long.toHexString(mask));\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooTrace.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:close()": {
        "source_code": "private void close() {\n    setStale();\n    if (!factory.removeCnxn(this)) {\n        return;\n    }\n    if (zkServer != null) {\n        zkServer.removeCnxn(this);\n    }\n    if (sk != null) {\n        try {\n            // need to cancel this selection key from the selector\n            sk.cancel();\n        } catch (Exception e) {\n            LOG.debug(\"ignoring exception during selectionkey cancel\", e);\n        }\n    }\n    closeSock();\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:checkFourLetterWord(java.nio.channels.SelectionKey,int)": {
        "source_code": "/**\n * Return if four letter word found and responded to, otw false *\n */\nprivate boolean checkFourLetterWord(final SelectionKey k, final int len) throws IOException {\n    // We take advantage of the limited size of the length to look\n    // for cmds. They are all 4-bytes which fits inside of an int\n    if (!FourLetterCommands.isKnown(len)) {\n        return false;\n    }\n    String cmd = FourLetterCommands.getCommandString(len);\n    packetReceived(4);\n    /**\n     * cancel the selection key to remove the socket handling\n     * from selector. This is to prevent netcat problem wherein\n     * netcat immediately closes the sending side after sending the\n     * commands and still keeps the receiving channel open.\n     * The idea is to remove the selectionkey from the selector\n     * so that the selector does not notice the closed read on the\n     * socket channel and keep the socket alive to write the data to\n     * and makes sure to close the socket after its done writing the data\n     */\n    if (k != null) {\n        try {\n            k.cancel();\n        } catch (Exception e) {\n            LOG.error(\"Error cancelling command selection key\", e);\n        }\n    }\n    final PrintWriter pwriter = new PrintWriter(new BufferedWriter(new SendBufferWriter()));\n    // ZOOKEEPER-2693: don't execute 4lw if it's not enabled.\n    if (!FourLetterCommands.isEnabled(cmd)) {\n        LOG.debug(\"Command {} is not executed because it is not in the whitelist.\", cmd);\n        NopCommand nopCmd = new NopCommand(pwriter, this, cmd + \" is not executed because it is not in the whitelist.\");\n        nopCmd.start();\n        return true;\n    }\n    LOG.info(\"Processing {} command from {}\", cmd, sock.socket().getRemoteSocketAddress());\n    if (len == FourLetterCommands.setTraceMaskCmd) {\n        incomingBuffer = ByteBuffer.allocate(8);\n        int rc = sock.read(incomingBuffer);\n        if (rc < 0) {\n            throw new IOException(\"Read error\");\n        }\n        incomingBuffer.flip();\n        long traceMask = incomingBuffer.getLong();\n        ZooTrace.setTextTraceLevel(traceMask);\n        SetTraceMaskCommand setMask = new SetTraceMaskCommand(pwriter, this, traceMask);\n        setMask.start();\n        return true;\n    } else {\n        CommandExecutor commandExecutor = new CommandExecutor();\n        return commandExecutor.execute(this, pwriter, len, zkServer, factory);\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:closeSock()": {
        "source_code": "/**\n * Close resources associated with the sock of this cnxn.\n */\nprivate void closeSock() {\n    if (!sock.isOpen()) {\n        return;\n    }\n    String logMsg = String.format(\"Closed socket connection for client %s %s\", sock.socket().getRemoteSocketAddress(), sessionId != 0 ? \"which had sessionid 0x\" + Long.toHexString(sessionId) : \"(no session established for client)\");\n    LOG.debug(logMsg);\n    closeSock(sock);\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    },
    "org.apache.zookeeper.server.NIOServerCnxn:readLength(java.nio.channels.SelectionKey)": {
        "source_code": "/**\n * Reads the first 4 bytes of lenBuffer, which could be true length or\n *  four letter word.\n *\n * @param k selection key\n * @return true if length read, otw false (wasn't really the length)\n * @throws IOException if buffer size exceeds maxBuffer size\n */\nprivate boolean readLength(SelectionKey k) throws IOException {\n    // Read the length, now get the buffer\n    int len = lenBuffer.getInt();\n    if (!initialized && checkFourLetterWord(sk, len)) {\n        return false;\n    }\n    if (len < 0 || len > BinaryInputArchive.maxBuffer) {\n        throw new IOException(\"Len error. \" + \"A message from \" + this.getRemoteSocketAddress() + \" with advertised length of \" + len + \" is either a malformed message or too large to process\" + \" (length is greater than jute.maxbuffer=\" + BinaryInputArchive.maxBuffer + \")\");\n    }\n    if (!isZKServerRunning()) {\n        throw new IOException(\"ZooKeeperServer not running\");\n    }\n    // checkRequestSize will throw IOException if request is rejected\n    zkServer.checkRequestSizeWhenReceivingMessage(len);\n    incomingBuffer = ByteBuffer.allocate(len);\n    return true;\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java"
    }
}