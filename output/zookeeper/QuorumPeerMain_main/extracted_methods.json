{
    "org.apache.zookeeper.jmx.ManagedUtil:registerLog4jMBeans()": {
        "source_code": "/**\n * Register the log4j JMX mbeans. Set system property\n * \"zookeeper.jmx.log4j.disable\" to true to disable registration.\n * @see <a href=\"http://logging.apache.org/log4j/1.2/apidocs/index.html?org/apache/log4j/jmx/package-summary.html\">Log4J 1.2 API docs</a>\n * @throws JMException if registration fails\n */\n@SuppressWarnings(\"rawtypes\")\npublic static void registerLog4jMBeans() throws JMException {\n    if (isLog4jJmxEnabled()) {\n        LOG.debug(\"registerLog4jMBeans()\");\n        MBeanServer mbs = MBeanRegistry.getInstance().getPlatformMBeanServer();\n        try {\n            // Create and Register the top level Log4J MBean\n            // org.apache.log4j.jmx.HierarchyDynamicMBean hdm = new org.apache.log4j.jmx.HierarchyDynamicMBean();\n            Object hdm = Class.forName(\"org.apache.log4j.jmx.HierarchyDynamicMBean\").getConstructor().newInstance();\n            String mbean = System.getProperty(\"zookeeper.jmx.log4j.mbean\", \"log4j:hierarchy=default\");\n            ObjectName mbo = new ObjectName(mbean);\n            mbs.registerMBean(hdm, mbo);\n            // Add the root logger to the Hierarchy MBean\n            // org.apache.log4j.Logger rootLogger =\n            // org.apache.log4j.Logger.getRootLogger();\n            Object rootLogger = Class.forName(\"org.apache.log4j.Logger\").getMethod(\"getRootLogger\", (Class<?>[]) null).invoke(null, (Object[]) null);\n            // hdm.addLoggerMBean(rootLogger.getName());\n            Object rootLoggerName = rootLogger.getClass().getMethod(\"getName\", (Class<?>[]) null).invoke(rootLogger, (Object[]) null);\n            hdm.getClass().getMethod(\"addLoggerMBean\", String.class).invoke(hdm, rootLoggerName);\n            // Get each logger from the Log4J Repository and add it to the\n            // Hierarchy MBean created above.\n            // org.apache.log4j.spi.LoggerRepository r =\n            // org.apache.log4j.LogManager.getLoggerRepository();\n            Object r = Class.forName(\"org.apache.log4j.LogManager\").getMethod(\"getLoggerRepository\", (Class<?>[]) null).invoke(null, (Object[]) null);\n            // Enumeration enumer = r.getCurrentLoggers();\n            Enumeration enumer = (Enumeration) r.getClass().getMethod(\"getCurrentLoggers\", (Class<?>[]) null).invoke(r, (Object[]) null);\n            while (enumer.hasMoreElements()) {\n                Object logger = enumer.nextElement();\n                // hdm.addLoggerMBean(logger.getName());\n                Object loggerName = logger.getClass().getMethod(\"getName\", (Class<?>[]) null).invoke(logger, (Object[]) null);\n                hdm.getClass().getMethod(\"addLoggerMBean\", String.class).invoke(hdm, loggerName);\n            }\n        } catch (Exception e) {\n            LOG.error(\"Problems while registering log4j 1.2 jmx beans!\", e);\n            throw new JMException(e.toString());\n        }\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/jmx/ManagedUtil.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeerConfig:getDataLogDir()": {
        "source_code": "public File getDataLogDir() {\n    return dataLogDir;\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerConfig.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeerMain:main(java.lang.String[])": {
        "source_code": "/**\n * To start the replicated server specify the configuration file name on\n * the command line.\n * @param args path to the configfile\n */\npublic static void main(String[] args) {\n    QuorumPeerMain main = new QuorumPeerMain();\n    try {\n        main.initializeAndRun(args);\n    } catch (IllegalArgumentException e) {\n        LOG.error(\"Invalid arguments, exiting abnormally\", e);\n        LOG.info(USAGE);\n        System.err.println(USAGE);\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.INVALID_INVOCATION.getValue());\n    } catch (ConfigException e) {\n        LOG.error(\"Invalid config, exiting abnormally\", e);\n        System.err.println(\"Invalid config, exiting abnormally\");\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.INVALID_INVOCATION.getValue());\n    } catch (DatadirException e) {\n        LOG.error(\"Unable to access datadir, exiting abnormally\", e);\n        System.err.println(\"Unable to access datadir, exiting abnormally\");\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.UNABLE_TO_ACCESS_DATADIR.getValue());\n    } catch (AdminServerException e) {\n        LOG.error(\"Unable to start AdminServer, exiting abnormally\", e);\n        System.err.println(\"Unable to start AdminServer, exiting abnormally\");\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.ERROR_STARTING_ADMIN_SERVER.getValue());\n    } catch (Exception e) {\n        LOG.error(\"Unexpected exception, exiting abnormally\", e);\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.UNEXPECTED_ERROR.getValue());\n    }\n    LOG.info(\"Exiting normally\");\n    ServiceUtils.requestSystemExit(ExitCode.EXECUTION_FINISHED.getValue());\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerMain.java"
    },
    "org.apache.zookeeper.server.ZooKeeperServerMain:main(java.lang.String[])": {
        "source_code": "/*\n     * Start up the ZooKeeper server.\n     *\n     * @param args the configfile or the port datadir [ticktime]\n     */\npublic static void main(String[] args) {\n    ZooKeeperServerMain main = new ZooKeeperServerMain();\n    try {\n        main.initializeAndRun(args);\n    } catch (IllegalArgumentException e) {\n        LOG.error(\"Invalid arguments, exiting abnormally\", e);\n        LOG.info(USAGE);\n        System.err.println(USAGE);\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.INVALID_INVOCATION.getValue());\n    } catch (ConfigException e) {\n        LOG.error(\"Invalid config, exiting abnormally\", e);\n        System.err.println(\"Invalid config, exiting abnormally\");\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.INVALID_INVOCATION.getValue());\n    } catch (DatadirException e) {\n        LOG.error(\"Unable to access datadir, exiting abnormally\", e);\n        System.err.println(\"Unable to access datadir, exiting abnormally\");\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.UNABLE_TO_ACCESS_DATADIR.getValue());\n    } catch (AdminServerException e) {\n        LOG.error(\"Unable to start AdminServer, exiting abnormally\", e);\n        System.err.println(\"Unable to start AdminServer, exiting abnormally\");\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.ERROR_STARTING_ADMIN_SERVER.getValue());\n    } catch (Exception e) {\n        LOG.error(\"Unexpected exception, exiting abnormally\", e);\n        ZKAuditProvider.addServerStartFailureAuditLog();\n        ServiceUtils.requestSystemExit(ExitCode.UNEXPECTED_ERROR.getValue());\n    }\n    LOG.info(\"Exiting normally\");\n    ServiceUtils.requestSystemExit(ExitCode.EXECUTION_FINISHED.getValue());\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServerMain.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeerMain:runFromConfig(org.apache.zookeeper.server.quorum.QuorumPeerConfig)": {
        "source_code": "public void runFromConfig(QuorumPeerConfig config) throws IOException, AdminServerException {\n    try {\n        ManagedUtil.registerLog4jMBeans();\n    } catch (JMException e) {\n        LOG.warn(\"Unable to register log4j JMX control\", e);\n    }\n    LOG.info(\"Starting quorum peer, myid=\" + config.getServerId());\n    final MetricsProvider metricsProvider;\n    try {\n        metricsProvider = MetricsProviderBootstrap.startMetricsProvider(config.getMetricsProviderClassName(), config.getMetricsProviderConfiguration());\n    } catch (MetricsProviderLifeCycleException error) {\n        throw new IOException(\"Cannot boot MetricsProvider \" + config.getMetricsProviderClassName(), error);\n    }\n    try {\n        ServerMetrics.metricsProviderInitialized(metricsProvider);\n        ProviderRegistry.initialize();\n        ServerCnxnFactory cnxnFactory = null;\n        ServerCnxnFactory secureCnxnFactory = null;\n        if (config.getClientPortAddress() != null) {\n            cnxnFactory = ServerCnxnFactory.createFactory();\n            cnxnFactory.configure(config.getClientPortAddress(), config.getMaxClientCnxns(), config.getClientPortListenBacklog(), false);\n        }\n        if (config.getSecureClientPortAddress() != null) {\n            secureCnxnFactory = ServerCnxnFactory.createFactory();\n            secureCnxnFactory.configure(config.getSecureClientPortAddress(), config.getMaxClientCnxns(), config.getClientPortListenBacklog(), true);\n        }\n        quorumPeer = getQuorumPeer();\n        quorumPeer.setTxnFactory(new FileTxnSnapLog(config.getDataLogDir(), config.getDataDir()));\n        quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());\n        quorumPeer.enableLocalSessionsUpgrading(config.isLocalSessionsUpgradingEnabled());\n        //quorumPeer.setQuorumPeers(config.getAllMembers());\n        quorumPeer.setElectionType(config.getElectionAlg());\n        quorumPeer.setMyid(config.getServerId());\n        quorumPeer.setTickTime(config.getTickTime());\n        quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());\n        quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());\n        quorumPeer.setInitLimit(config.getInitLimit());\n        quorumPeer.setSyncLimit(config.getSyncLimit());\n        quorumPeer.setConnectToLearnerMasterLimit(config.getConnectToLearnerMasterLimit());\n        quorumPeer.setObserverMasterPort(config.getObserverMasterPort());\n        quorumPeer.setConfigFileName(config.getConfigFilename());\n        quorumPeer.setClientPortListenBacklog(config.getClientPortListenBacklog());\n        quorumPeer.setMaxClientCnxns(config.getMaxClientCnxns());\n        quorumPeer.setZKDatabase(new ZKDatabase(quorumPeer.getTxnFactory()));\n        quorumPeer.setQuorumVerifier(config.getQuorumVerifier(), false);\n        if (config.getLastSeenQuorumVerifier() != null) {\n            quorumPeer.setLastSeenQuorumVerifier(config.getLastSeenQuorumVerifier(), false);\n        }\n        quorumPeer.initConfigInZKDatabase();\n        quorumPeer.setCnxnFactory(cnxnFactory);\n        quorumPeer.setSecureCnxnFactory(secureCnxnFactory);\n        quorumPeer.setSslQuorum(config.isSslQuorum());\n        quorumPeer.setUsePortUnification(config.shouldUsePortUnification());\n        quorumPeer.setLearnerType(config.getPeerType());\n        quorumPeer.setSyncEnabled(config.getSyncEnabled());\n        quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());\n        if (config.sslQuorumReloadCertFiles) {\n            quorumPeer.getX509Util().enableCertFileReloading();\n        }\n        quorumPeer.setMultiAddressEnabled(config.isMultiAddressEnabled());\n        quorumPeer.setMultiAddressReachabilityCheckEnabled(config.isMultiAddressReachabilityCheckEnabled());\n        quorumPeer.setMultiAddressReachabilityCheckTimeoutMs(config.getMultiAddressReachabilityCheckTimeoutMs());\n        // sets quorum sasl authentication configurations\n        quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);\n        if (quorumPeer.isQuorumSaslAuthEnabled()) {\n            quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);\n            quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);\n            quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);\n            quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);\n            quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);\n        }\n        quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);\n        quorumPeer.initialize();\n        if (config.jvmPauseMonitorToRun) {\n            quorumPeer.setJvmPauseMonitor(new JvmPauseMonitor(config));\n        }\n        quorumPeer.start();\n        ZKAuditProvider.addZKStartStopAuditLog();\n        quorumPeer.join();\n    } catch (InterruptedException e) {\n        // warn, but generally this is ok\n        LOG.warn(\"Quorum Peer interrupted\", e);\n    } finally {\n        try {\n            metricsProvider.stop();\n        } catch (Throwable error) {\n            LOG.warn(\"Error while stopping metrics\", error);\n        }\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerMain.java"
    },
    "org.apache.zookeeper.server.persistence.FileTxnSnapLog:<init>(java.io.File,java.io.File)": {
        "source_code": "/**\n * the constructor which takes the datadir and\n * snapdir.\n * @param dataDir the transaction directory\n * @param snapDir the snapshot directory\n */\npublic FileTxnSnapLog(File dataDir, File snapDir) throws IOException {\n    LOG.debug(\"Opening datadir:{} snapDir:{}\", dataDir, snapDir);\n    this.dataDir = new File(dataDir, version + VERSION);\n    this.snapDir = new File(snapDir, version + VERSION);\n    // by default create snap/log dirs, but otherwise complain instead\n    // See ZOOKEEPER-1161 for more details\n    boolean enableAutocreate = Boolean.parseBoolean(System.getProperty(ZOOKEEPER_DATADIR_AUTOCREATE, ZOOKEEPER_DATADIR_AUTOCREATE_DEFAULT));\n    trustEmptySnapshot = Boolean.getBoolean(ZOOKEEPER_SNAPSHOT_TRUST_EMPTY);\n    LOG.info(\"{} : {}\", ZOOKEEPER_SNAPSHOT_TRUST_EMPTY, trustEmptySnapshot);\n    if (!this.dataDir.exists()) {\n        if (!enableAutocreate) {\n            throw new DatadirException(String.format(\"Missing data directory %s, automatic data directory creation is disabled (%s is false).\" + \" Please create this directory manually.\", this.dataDir, ZOOKEEPER_DATADIR_AUTOCREATE));\n        }\n        if (!this.dataDir.mkdirs() && !this.dataDir.exists()) {\n            throw new DatadirException(\"Unable to create data directory \" + this.dataDir);\n        }\n    }\n    if (!this.dataDir.canWrite()) {\n        throw new DatadirException(\"Cannot write to data directory \" + this.dataDir);\n    }\n    if (!this.snapDir.exists()) {\n        // by default create this directory, but otherwise complain instead\n        // See ZOOKEEPER-1161 for more details\n        if (!enableAutocreate) {\n            throw new DatadirException(String.format(\"Missing snap directory %s, automatic data directory creation is disabled (%s is false).\" + \"Please create this directory manually.\", this.snapDir, ZOOKEEPER_DATADIR_AUTOCREATE));\n        }\n        if (!this.snapDir.mkdirs() && !this.snapDir.exists()) {\n            throw new DatadirException(\"Unable to create snap directory \" + this.snapDir);\n        }\n    }\n    if (!this.snapDir.canWrite()) {\n        throw new DatadirException(\"Cannot write to snap directory \" + this.snapDir);\n    }\n    // check content of transaction log and snapshot dirs if they are two different directories\n    // See ZOOKEEPER-2967 for more details\n    if (!this.dataDir.getPath().equals(this.snapDir.getPath())) {\n        checkLogDir();\n        checkSnapDir();\n    }\n    txnLog = new FileTxnLog(this.dataDir);\n    snapLog = new FileSnap(this.snapDir);\n    autoCreateDB = Boolean.parseBoolean(System.getProperty(ZOOKEEPER_DB_AUTOCREATE, ZOOKEEPER_DB_AUTOCREATE_DEFAULT));\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnSnapLog.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeerConfig:parse(java.lang.String)": {
        "source_code": "/**\n * Parse a ZooKeeper configuration file\n * @param path the patch of the configuration file\n * @throws ConfigException error processing configuration\n */\npublic void parse(String path) throws ConfigException {\n    LOG.info(\"Reading configuration from: \" + path);\n    try {\n        File configFile = (new VerifyingFileFactory.Builder(LOG).warnForRelativePath().failForNonExistingPath().build()).create(path);\n        Properties cfg = new Properties();\n        try (FileInputStream in = new FileInputStream(configFile)) {\n            cfg.load(in);\n            configFileStr = path;\n        }\n        /* Read entire config file as initial configuration */\n        initialConfig = new String(Files.readAllBytes(configFile.toPath()));\n        parseProperties(cfg);\n    } catch (IOException e) {\n        throw new ConfigException(\"Error processing \" + path, e);\n    } catch (IllegalArgumentException e) {\n        throw new ConfigException(\"Error processing \" + path, e);\n    }\n    if (dynamicConfigFileStr != null) {\n        try {\n            Properties dynamicCfg = new Properties();\n            try (FileInputStream inConfig = new FileInputStream(dynamicConfigFileStr)) {\n                dynamicCfg.load(inConfig);\n                if (dynamicCfg.getProperty(\"version\") != null) {\n                    throw new ConfigException(\"dynamic file shouldn't have version inside\");\n                }\n                String version = getVersionFromFilename(dynamicConfigFileStr);\n                // If there isn't any version associated with the filename,\n                // the default version is 0.\n                if (version != null) {\n                    dynamicCfg.setProperty(\"version\", version);\n                }\n            }\n            setupQuorumPeerConfig(dynamicCfg, false);\n        } catch (IOException e) {\n            throw new ConfigException(\"Error processing \" + dynamicConfigFileStr, e);\n        } catch (IllegalArgumentException e) {\n            throw new ConfigException(\"Error processing \" + dynamicConfigFileStr, e);\n        }\n        File nextDynamicConfigFile = new File(configFileStr + nextDynamicConfigFileSuffix);\n        if (nextDynamicConfigFile.exists()) {\n            try {\n                Properties dynamicConfigNextCfg = new Properties();\n                try (FileInputStream inConfigNext = new FileInputStream(nextDynamicConfigFile)) {\n                    dynamicConfigNextCfg.load(inConfigNext);\n                }\n                boolean isHierarchical = false;\n                for (Entry<Object, Object> entry : dynamicConfigNextCfg.entrySet()) {\n                    String key = entry.getKey().toString().trim();\n                    if (key.startsWith(\"group\") || key.startsWith(\"weight\")) {\n                        isHierarchical = true;\n                        break;\n                    }\n                }\n                lastSeenQuorumVerifier = createQuorumVerifier(dynamicConfigNextCfg, isHierarchical);\n            } catch (IOException e) {\n                LOG.warn(\"NextQuorumVerifier is initiated to null\");\n            }\n        }\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerConfig.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeerMain:initializeAndRun(java.lang.String[])": {
        "source_code": "protected void initializeAndRun(String[] args) throws ConfigException, IOException, AdminServerException {\n    QuorumPeerConfig config = new QuorumPeerConfig();\n    if (args.length == 1) {\n        config.parse(args[0]);\n    }\n    // Start and schedule the purge task\n    DatadirCleanupManager purgeMgr = new DatadirCleanupManager(config.getDataDir(), config.getDataLogDir(), config.getSnapRetainCount(), config.getPurgeIntervalInMs());\n    purgeMgr.start();\n    if (args.length == 1 && config.isDistributed()) {\n        runFromConfig(config);\n    } else {\n        LOG.warn(\"Either no config or no quorum defined in config, running in standalone mode\");\n        // there is only server in the quorum -- run as standalone\n        ZooKeeperServerMain.main(args);\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerMain.java"
    },
    "org.apache.zookeeper.server.DatadirCleanupManager:start()": {
        "source_code": "/**\n * Validates the purge configuration and schedules the purge task. Purge\n * task keeps the most recent <code>snapRetainCount</code> number of\n * snapshots and deletes the remaining for every <code>purgeInterval</code>\n * hour(s).\n * <p>\n * <code>purgeInterval</code> of <code>0</code> or\n * <code>negative integer</code> will not schedule the purge task.\n * </p>\n *\n * @see PurgeTxnLog#purge(File, File, int)\n */\npublic void start() {\n    if (PurgeTaskStatus.STARTED == purgeTaskStatus) {\n        LOG.warn(\"Purge task is already running.\");\n        return;\n    }\n    // Don't schedule the purge task with zero or negative purge interval.\n    if (purgeIntervalInMs <= 0) {\n        LOG.info(\"Purge task is not scheduled.\");\n        return;\n    }\n    timer = new Timer(\"PurgeTask\", true);\n    TimerTask task = new PurgeTask(dataLogDir, snapDir, snapRetainCount);\n    timer.scheduleAtFixedRate(task, 0, purgeIntervalInMs);\n    purgeTaskStatus = PurgeTaskStatus.STARTED;\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/DatadirCleanupManager.java"
    }
}