{
    "org.apache.zookeeper.server.quorum.QuorumPeer:createElectionAlgorithm(int)": {
        "source_code": "@SuppressWarnings(\"deprecation\")\nprotected Election createElectionAlgorithm(int electionAlgorithm) {\n    Election le = null;\n    //TODO: use a factory rather than a switch\n    switch(electionAlgorithm) {\n        case 1:\n            throw new UnsupportedOperationException(\"Election Algorithm 1 is not supported.\");\n        case 2:\n            throw new UnsupportedOperationException(\"Election Algorithm 2 is not supported.\");\n        case 3:\n            QuorumCnxManager qcm = createCnxnManager();\n            QuorumCnxManager oldQcm = qcmRef.getAndSet(qcm);\n            if (oldQcm != null) {\n                LOG.warn(\"Clobbering already-set QuorumCnxManager (restarting leader election?)\");\n                oldQcm.halt();\n            }\n            QuorumCnxManager.Listener listener = qcm.listener;\n            if (listener != null) {\n                listener.start();\n                FastLeaderElection fle = new FastLeaderElection(this, qcm);\n                fle.start();\n                le = fle;\n            } else {\n                LOG.error(\"Null listener when initializing cnx manager\");\n            }\n            break;\n        default:\n            assert false;\n    }\n    return le;\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeer$ResponderThread:run()": {
        "source_code": "@Override\npublic void run() {\n    try {\n        byte[] b = new byte[36];\n        ByteBuffer responseBuffer = ByteBuffer.wrap(b);\n        DatagramPacket packet = new DatagramPacket(b, b.length);\n        while (running) {\n            udpSocket.receive(packet);\n            if (packet.getLength() != 4) {\n                LOG.warn(\"Got more than just an xid! Len = {}\", packet.getLength());\n            } else {\n                responseBuffer.clear();\n                // Skip the xid\n                responseBuffer.getInt();\n                responseBuffer.putLong(myid);\n                Vote current = getCurrentVote();\n                switch(getPeerState()) {\n                    case LOOKING:\n                        responseBuffer.putLong(current.getId());\n                        responseBuffer.putLong(current.getZxid());\n                        break;\n                    case LEADING:\n                        responseBuffer.putLong(myid);\n                        try {\n                            long proposed;\n                            synchronized (leader) {\n                                proposed = leader.lastProposed;\n                            }\n                            responseBuffer.putLong(proposed);\n                        } catch (NullPointerException npe) {\n                            // This can happen in state transitions,\n                            // just ignore the request\n                        }\n                        break;\n                    case FOLLOWING:\n                        responseBuffer.putLong(current.getId());\n                        try {\n                            responseBuffer.putLong(follower.getZxid());\n                        } catch (NullPointerException npe) {\n                            // This can happen in state transitions,\n                            // just ignore the request\n                        }\n                        break;\n                    case OBSERVING:\n                        // Do nothing, Observers keep themselves to\n                        // themselves.\n                        break;\n                }\n                packet.setData(b);\n                udpSocket.send(packet);\n            }\n            packet.setLength(b.length);\n        }\n    } catch (RuntimeException e) {\n        LOG.warn(\"Unexpected runtime exception in ResponderThread\", e);\n    } catch (IOException e) {\n        LOG.warn(\"Unexpected IO exception in ResponderThread\", e);\n    } finally {\n        LOG.warn(\"QuorumPeer responder thread exited\");\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeer:startLeaderElection()": {
        "source_code": "public synchronized void startLeaderElection() {\n    try {\n        if (getPeerState() == ServerState.LOOKING) {\n            currentVote = new Vote(myid, getLastLoggedZxid(), getCurrentEpoch());\n        }\n    } catch (IOException e) {\n        RuntimeException re = new RuntimeException(e.getMessage());\n        re.setStackTrace(e.getStackTrace());\n        throw re;\n    }\n    this.electionAlg = createElectionAlgorithm(electionType);\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeer:loadDataBase()": {
        "source_code": "private void loadDataBase() {\n    try {\n        zkDb.loadDataBase();\n        // load the epochs\n        long lastProcessedZxid = zkDb.getDataTree().lastProcessedZxid;\n        long epochOfZxid = ZxidUtils.getEpochFromZxid(lastProcessedZxid);\n        try {\n            currentEpoch = readLongFromFile(CURRENT_EPOCH_FILENAME);\n        } catch (FileNotFoundException e) {\n            // pick a reasonable epoch number\n            // this should only happen once when moving to a\n            // new code version\n            currentEpoch = epochOfZxid;\n            LOG.info(\"{} not found! Creating with a reasonable default of {}. \" + \"This should only happen when you are upgrading your installation\", CURRENT_EPOCH_FILENAME, currentEpoch);\n            writeLongToFile(CURRENT_EPOCH_FILENAME, currentEpoch);\n        }\n        if (epochOfZxid > currentEpoch) {\n            // acceptedEpoch.tmp file in snapshot directory\n            File currentTmp = new File(getTxnFactory().getSnapDir(), CURRENT_EPOCH_FILENAME + AtomicFileOutputStream.TMP_EXTENSION);\n            if (currentTmp.exists()) {\n                long epochOfTmp = readLongFromFile(currentTmp.getName());\n                LOG.info(\"{} found. Setting current epoch to {}.\", currentTmp, epochOfTmp);\n                setCurrentEpoch(epochOfTmp);\n            } else {\n                throw new IOException(\"The current epoch, \" + ZxidUtils.zxidToString(currentEpoch) + \", is older than the last zxid, \" + lastProcessedZxid);\n            }\n        }\n        try {\n            acceptedEpoch = readLongFromFile(ACCEPTED_EPOCH_FILENAME);\n        } catch (FileNotFoundException e) {\n            // pick a reasonable epoch number\n            // this should only happen once when moving to a\n            // new code version\n            acceptedEpoch = epochOfZxid;\n            LOG.info(\"{} not found! Creating with a reasonable default of {}. \" + \"This should only happen when you are upgrading your installation\", ACCEPTED_EPOCH_FILENAME, acceptedEpoch);\n            writeLongToFile(ACCEPTED_EPOCH_FILENAME, acceptedEpoch);\n        }\n        if (acceptedEpoch < currentEpoch) {\n            throw new IOException(\"The accepted epoch, \" + ZxidUtils.zxidToString(acceptedEpoch) + \" is less than the current epoch, \" + ZxidUtils.zxidToString(currentEpoch));\n        }\n    } catch (IOException ie) {\n        LOG.error(\"Unable to load database on disk\", ie);\n        throw new RuntimeException(\"Unable to run quorum server \", ie);\n    }\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java"
    },
    "org.apache.zookeeper.server.quorum.QuorumPeer:getLastLoggedZxid()": {
        "source_code": "/**\n * returns the highest zxid that this host has seen\n *\n * @return the highest zxid for this host\n */\npublic long getLastLoggedZxid() {\n    if (!zkDb.isInitialized()) {\n        loadDataBase();\n    }\n    return zkDb.getDataTreeLastProcessedZxid();\n}",
        "file_path": "zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeer.java"
    }
}